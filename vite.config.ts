// ============================================================================
// VITE CONFIGURATION - Best Practices для React + TypeScript проекта
// ============================================================================
// Документация: https://vite.dev/config/
// ============================================================================

import { defineConfig, loadEnv } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";

// ============================================================================
// ЭКСПОРТ КОНФИГУРАЦИИ
// ============================================================================
// defineConfig - хелпер от Vite для типизации и автодополнения
// Используем функцию вместо объекта, чтобы получить доступ к mode и command
// mode - режим сборки ('development' | 'production' | 'test')
// command - команда запуска ('serve' | 'build')
// ============================================================================

export default defineConfig(({ mode }) => {
  // ==========================================================================
  // ЗАГРУЗКА ПЕРЕМЕННЫХ ОКРУЖЕНИЯ
  // ==========================================================================
  // loadEnv загружает переменные из .env файлов в зависимости от режима:
  // - .env                 - загружается всегда
  // - .env.local           - загружается всегда, игнорируется git
  // - .env.[mode]          - загружается только в указанном режиме
  // - .env.[mode].local    - загружается только в указанном режиме, игнорируется git
  //
  // Параметры loadEnv:
  // 1. mode - текущий режим (development/production)
  // 2. process.cwd() - директория для поиска .env файлов
  // 3. '' - префикс переменных (пустой = загрузить все переменные)
  //
  // ВАЖНО: По умолчанию Vite загружает только переменные с префиксом VITE_
  // Передавая '' мы загружаем ВСЕ переменные для использования в конфигурации
  // ==========================================================================
  const env = loadEnv(mode, process.cwd(), "");

  return {
    // ========================================================================
    // ПЛАГИНЫ
    // ========================================================================
    // Плагины расширяют функциональность Vite
    // react() - официальный плагин для поддержки React:
    //   - Fast Refresh (HMR для React компонентов)
    //   - JSX трансформация
    //   - Поддержка React DevTools
    // ========================================================================
    plugins: [
      react({
        // Babel plugins для дополнительных возможностей (опционально)
        // babel: {
        //   plugins: ['@emotion/babel-plugin'] // пример для Emotion CSS-in-JS
        // }
      }),
    ],

    // ========================================================================
    // РАЗРЕШЕНИЕ ПУТЕЙ (RESOLVE)
    // ========================================================================
    // Настройка алиасов для удобного импорта модулей
    // Вместо: import Component from '../../../components/Button'
    // Можно:  import Component from '@/components/Button'
    //
    // ВАЖНО: Для работы с TypeScript нужно также настроить paths в tsconfig.json
    // ========================================================================
    resolve: {
      alias: {
        // '@' указывает на папку src - самый популярный паттерн
        "@": path.resolve(__dirname, "./src"),

        // Дополнительные алиасы для крупных проектов:
        // '@components': path.resolve(__dirname, './src/components'),
        // '@hooks': path.resolve(__dirname, './src/hooks'),
        // '@utils': path.resolve(__dirname, './src/utils'),
        // '@assets': path.resolve(__dirname, './src/assets'),
        // '@styles': path.resolve(__dirname, './src/styles'),
        // '@api': path.resolve(__dirname, './src/api'),
        // '@store': path.resolve(__dirname, './src/store'),
        // '@types': path.resolve(__dirname, './src/types'),
      },
    },

    // ========================================================================
    // СЕРВЕР РАЗРАБОТКИ (DEV SERVER)
    // ========================================================================
    // Настройки для команды `vite` (npm run dev)
    // ========================================================================
    server: {
      // Порт сервера разработки
      // Берём из .env или используем 3000 по умолчанию
      port: env.VITE_PORT ? parseInt(env.VITE_PORT, 10) : 3000,

      // strictPort: true - если порт занят, сервер выдаст ошибку
      // strictPort: false - если порт занят, попробует следующий свободный
      strictPort: true,

      // Автоматически открывать браузер при запуске
      open: true,

      // Host для доступа с других устройств в сети
      // 'localhost' - только локально
      // '0.0.0.0' или true - доступ из локальной сети (для тестирования на телефоне)
      host: true,

      // Hot Module Replacement - мгновенное обновление без перезагрузки страницы
      hmr: {
        // overlay: показывать ошибки поверх страницы
        overlay: true,
      },

      // ======================================================================
      // ПРОКСИ ДЛЯ API ЗАПРОСОВ
      // ======================================================================
      // Решает проблему CORS при разработке
      // Все запросы на /api будут проксироваться на бэкенд сервер
      //
      // Пример: fetch('/api/users') -> http://localhost:8080/api/users
      // ======================================================================
      proxy: {
        "/api": {
          // URL вашего бэкенд сервера
          target: env.VITE_API_URL || "http://localhost:8080",

          // Изменять заголовок Origin для бэкенда
          changeOrigin: true,

          // Для HTTPS бэкенда с самоподписанным сертификатом
          secure: false,

          // Перезапись пути (опционально)
          // rewrite: (path) => path.replace(/^\/api/, ''),
        },
      },

      // Следить за изменениями в этих файлах и перезапускать сервер
      watch: {
        // Игнорировать node_modules для производительности
        ignored: ["**/node_modules/**"],
      },
    },

    // ========================================================================
    // СЕРВЕР ПРЕВЬЮ (PREVIEW)
    // ========================================================================
    // Настройки для команды `vite preview` (просмотр production сборки)
    // ========================================================================
    preview: {
      port: env.VITE_PREVIEW_PORT ? parseInt(env.VITE_PREVIEW_PORT, 10) : 4173,
      open: true,
      host: true,
    },

    // ========================================================================
    // НАСТРОЙКИ СБОРКИ (BUILD)
    // ========================================================================
    // Настройки для команды `vite build` (npm run build)
    // ========================================================================
    build: {
      // Директория для сборки
      outDir: "build",

      // Директория для статических ассетов внутри outDir
      assetsDir: "assets",

      // Генерировать source maps для production
      // true - генерировать (удобно для дебага в production)
      // false - не генерировать (меньше размер, безопаснее)
      // 'hidden' - генерировать, но не добавлять ссылку в файлы
      sourcemap: mode === "development",

      // Минимальный размер файла для создания отдельного чанка (в байтах)
      // Файлы меньше этого размера будут инлайнены как base64
      assetsInlineLimit: 4096, // 4KB

      // Лимит предупреждения о размере чанка (в KB)
      chunkSizeWarningLimit: 500,

      // Очистить директорию сборки перед новой сборкой
      emptyOutDir: true,

      // Настройки Rollup/Rolldown (бандлер который использует Vite для production)
      rollupOptions: {
        output: {
          // ================================================================
          // CODE SPLITTING - разделение кода на чанки
          // ================================================================
          // Оптимизирует загрузку: браузер кэширует vendor библиотеки
          // отдельно от кода приложения
          //
          // manualChunks - функция для определения в какой чанк попадёт модуль
          // id - путь к модулю (например: /node_modules/react/index.js)
          // Возвращаем имя чанка или undefined (для стандартного поведения)
          // ================================================================
          manualChunks(id: string): string | undefined {
            // Выделяем React в отдельный vendor чанк
            // Эти библиотеки редко обновляются, поэтому браузер будет кэшировать их
            if (id.includes("node_modules/react")) {
              return "vendor-react";
            }

            // Другие крупные библиотеки можно выделить отдельно:
            // if (id.includes('node_modules/react-router')) {
            //   return 'vendor-router'
            // }
            // if (id.includes('node_modules/@mui') || id.includes('node_modules/@emotion')) {
            //   return 'vendor-ui'
            // }

            // Все остальные node_modules в общий vendor чанк
            if (id.includes("node_modules")) {
              return "vendor";
            }

            // Явно возвращаем undefined для модулей приложения
            // (они будут обработаны стандартным алгоритмом Vite)
            return undefined;
          },

          // Формат имён файлов для лучшего кэширования
          // [hash] - хэш содержимого файла (меняется только при изменении кода)
          chunkFileNames: "assets/js/[name]-[hash].js",
          entryFileNames: "assets/js/[name]-[hash].js",
          assetFileNames: "assets/[ext]/[name]-[hash].[ext]",
        },
      },

      // Целевые браузеры для сборки
      // Современные браузеры поддерживают ES2020+
      target: "es2020",

      // CSS code split - выделять CSS в отдельные файлы
      cssCodeSplit: true,

      // Минификация CSS
      cssMinify: true,

      // Минификация JS
      // В rolldown-vite используется встроенный минификатор oxc
      // true - включить минификацию (по умолчанию в production)
      // false - отключить минификацию
      // Примечание: 'esbuild' и 'terser' требуют отдельной установки пакетов
      minify: true,
    },

    // ========================================================================
    // НАСТРОЙКИ CSS
    // ========================================================================
    css: {
      // Настройки модулей CSS (*.module.css)
      modules: {
        // Формат генерируемых имён классов
        // В development: понятные имена для дебага
        // В production: короткие хэши для минимального размера
        generateScopedName:
          mode === "development"
            ? "[name]__[local]__[hash:base64:5]"
            : "[hash:base64:8]",

        // Включать глобальные стили (начинающиеся с :global)
        localsConvention: "camelCaseOnly",
      },

      // Настройки препроцессоров (если используете SCSS/SASS/Less)
      preprocessorOptions: {
        // Пример для SCSS:
        // scss: {
        //   // Автоматически импортировать переменные/миксины во все файлы
        //   additionalData: `@import "@/styles/variables.scss";`,
        // },
      },

      // Включить CSS source maps в development
      devSourcemap: true,
    },

    // ========================================================================
    // ОПТИМИЗАЦИЯ ЗАВИСИМОСТЕЙ (DEP OPTIMIZATION)
    // ========================================================================
    // Vite предварительно бандлит зависимости для ускорения dev сервера
    // ========================================================================
    optimizeDeps: {
      // Зависимости для предварительной оптимизации
      // Добавляйте сюда пакеты, которые Vite не обнаружил автоматически
      include: ["react", "react-dom"],

      // Исключить из оптимизации (например, пакеты с динамическими импортами)
      // exclude: ['some-package'],

      // Принудительно пересобрать кэш зависимостей при изменении этих файлов
      // entries: ['./src/main.tsx'],
    },

    // ========================================================================
    // ОПРЕДЕЛЕНИЕ ГЛОБАЛЬНЫХ КОНСТАНТ
    // ========================================================================
    // Заменяются на этапе сборки (dead code elimination)
    // ========================================================================
    define: {
      // Версия приложения из package.json
      __APP_VERSION__: JSON.stringify(process.env.npm_package_version),

      // Режим сборки
      __DEV__: mode === "development",
      __PROD__: mode === "production",
    },

    // ========================================================================
    // ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ
    // ========================================================================
    // Префикс для переменных, доступных в клиентском коде
    // По умолчанию 'VITE_' - только переменные с этим префиксом
    // будут доступны через import.meta.env
    //
    // БЕЗОПАСНОСТЬ: Никогда не используйте переменные без префикса
    // в клиентском коде - они могут содержать секретные данные!
    // ========================================================================
    envPrefix: "VITE_",

    // ========================================================================
    // ЖУРНАЛИРОВАНИЕ (LOGGING)
    // ========================================================================
    // Уровень логирования: 'info' | 'warn' | 'error' | 'silent'
    // ========================================================================
    logLevel: "info",

    // Очистить терминал при запуске сервера
    clearScreen: true,

    // ========================================================================
    // БАЗОВЫЙ ПУТЬ
    // ========================================================================
    // Путь к приложению от корня домена
    // '/' - корень (https://example.com/)
    // '/app/' - поддиректория (https://example.com/app/)
    //
    // ВАЖНО для деплоя на GitHub Pages, Vercel subdirectory и т.д.
    // ========================================================================
    base: env.VITE_BASE_URL || "/",

    // ========================================================================
    // ПУБЛИЧНАЯ ДИРЕКТОРИЯ
    // ========================================================================
    // Файлы из этой директории копируются в корень public без обработки
    // Полезно для: favicon.ico, robots.txt, manifest.json
    // ========================================================================
    publicDir: "public",

    // ========================================================================
    // КЭШИРОВАНИЕ
    // ========================================================================
    // Директория для кэша Vite
    // ========================================================================
    cacheDir: "node_modules/.vite",
  };
});
