// ============================================================================
// КОНФИГУРАЦИЯ СЕРВЕРА РАЗРАБОТКИ (DEV SERVER)
// ============================================================================
// Настройки для команды `vite` (npm run dev)
// ============================================================================

import type { ServerOptions } from 'vite'
import type { EnvVariables } from './types'

/**
 * Получить конфигурацию сервера разработки
 * @param env - переменные окружения
 */
export function getServerConfig(env: EnvVariables): ServerOptions {
	return {
		// Порт сервера разработки
		// Берём из .env или используем 3000 по умолчанию
		port: env.VITE_PORT ? parseInt(env.VITE_PORT, 10) : 3000,

		// strictPort: true - если порт занят, сервер выдаст ошибку
		// strictPort: false - если порт занят, попробует следующий свободный
		strictPort: true,

		// Автоматически открывать браузер при запуске
		open: true,

		// Host для доступа с других устройств в сети
		// 'localhost' - только локально
		// '0.0.0.0' или true - доступ из локальной сети (для тестирования на телефоне)
		host: true,

		// Hot Module Replacement - мгновенное обновление без перезагрузки страницы
		hmr: {
			// overlay: показывать ошибки поверх страницы
			overlay: true,
		},

		// ========================================================================
		// ПРОКСИ ДЛЯ API ЗАПРОСОВ
		// ========================================================================
		// Решает проблему CORS при разработке
		// Все запросы на /api будут проксироваться на бэкенд сервер
		//
		// Пример: fetch('/api/users') -> http://localhost:8080/api/users
		// ========================================================================
		proxy: {
			'/api': {
				// URL вашего бэкенд сервера
				target: env.VITE_API_URL || 'http://localhost:8080',

				// Изменять заголовок Origin для бэкенда
				changeOrigin: true,

				// Для HTTPS бэкенда с самоподписанным сертификатом
				secure: false,

				// Перезапись пути (опционально)
				// rewrite: (path) => path.replace(/^\/api/, ''),
			},
		},

		// Следить за изменениями в этих файлах и перезапускать сервер
		watch: {
			// Игнорировать node_modules для производительности
			ignored: ['**/node_modules/**'],
		},
	}
}
